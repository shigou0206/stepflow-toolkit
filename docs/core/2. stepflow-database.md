# stepflow-database - æ•°æ®åº“å±‚

## ğŸ“‹ æ¦‚è¿°

`stepflow-database` è´Ÿè´£æ•°æ®åº“è¿æ¥å’Œæ“ä½œï¼Œæä¾›æ•°æ®è®¿é—®å±‚çš„æŠ½è±¡æ¥å£ã€‚

**èŒè´£**: 
- SQLite è¿æ¥ç®¡ç†
- æ•°æ®åº“æ¨¡å‹å®šä¹‰
- è¿ç§»è„šæœ¬ç®¡ç†
- æ•°æ®è®¿é—®å±‚ (Repository Pattern)

---

## ğŸ—ï¸ åŒ…ç»“æ„

```
stepflow-database/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs              # åº“å…¥å£
â”‚   â”œâ”€â”€ connection.rs        # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ models.rs           # æ•°æ®åº“æ¨¡å‹
â”‚   â”œâ”€â”€ migrations/         # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ repository.rs       # æ•°æ®è®¿é—®å±‚
â”‚   â””â”€â”€ error.rs            # æ•°æ®åº“é”™è¯¯ç±»å‹
â”œâ”€â”€ migrations/             # SQL è¿ç§»æ–‡ä»¶
â””â”€â”€ Cargo.toml
```

---

## ğŸ“¦ ä¾èµ–é…ç½®

```toml
[dependencies]
sqlx = { version = "0.7", features = ["runtime-tokio-rustls", "sqlite", "chrono"] }
stepflow-core = { path = "../stepflow-core" }
tokio = { version = "1.0", features = ["full"] }
anyhow = "1.0"
```

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

### 1. tools è¡¨ - å·¥å…·å­˜å‚¨

```sql
CREATE TABLE tools (
    id TEXT PRIMARY KEY CHECK (id REGEXP '^tool:[^/]+/[^@]+@[^@]+$'),
    name TEXT NOT NULL,
    tool_type TEXT NOT NULL,
    version TEXT NOT NULL,
    tenant_id TEXT NOT NULL,
    input_schema TEXT NOT NULL,  -- JSON stored as TEXT
    output_schema TEXT NOT NULL, -- JSON stored as TEXT
    config TEXT NOT NULL,        -- JSON stored as TEXT
    tags TEXT NOT NULL,          -- JSON array stored as TEXT
    category TEXT,
    registered_at DATETIME NOT NULL DEFAULT (datetime('now')),
    execution_config TEXT NOT NULL, -- JSON stored as TEXT
    created_at DATETIME NOT NULL DEFAULT (datetime('now')),
    updated_at DATETIME NOT NULL DEFAULT (datetime('now'))
);
```

### 2. tool_executions è¡¨ - æ‰§è¡Œè®°å½•

```sql
CREATE TABLE tool_executions (
    id TEXT PRIMARY KEY,  -- UUID
    tool_id TEXT NOT NULL,
    tenant_id TEXT NOT NULL,
    input_data TEXT NOT NULL,  -- JSON stored as TEXT
    output_data TEXT,          -- JSON stored as TEXT
    status TEXT NOT NULL,      -- pending, running, completed, failed, cancelled, timeout
    error_message TEXT,
    duration_ms INTEGER,
    started_at DATETIME NOT NULL DEFAULT (datetime('now')),
    completed_at DATETIME,
    created_at DATETIME NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (tool_id) REFERENCES tools(id) ON DELETE CASCADE
);
```

### 3. tool_metrics è¡¨ - æ‰§è¡ŒæŒ‡æ ‡

```sql
CREATE TABLE tool_metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tool_id TEXT NOT NULL,
    tenant_id TEXT NOT NULL,
    execution_count INTEGER NOT NULL DEFAULT 0,
    success_count INTEGER NOT NULL DEFAULT 0,
    error_count INTEGER NOT NULL DEFAULT 0,
    avg_duration_ms INTEGER,
    last_executed_at DATETIME,
    created_at DATETIME NOT NULL DEFAULT (datetime('now')),
    updated_at DATETIME NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (tool_id) REFERENCES tools(id) ON DELETE CASCADE
);
```

### 4. tool_logs è¡¨ - å®¡è®¡æ—¥å¿—

```sql
CREATE TABLE tool_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tool_id TEXT NOT NULL,
    tenant_id TEXT NOT NULL,
    execution_id TEXT NOT NULL,
    log_level TEXT NOT NULL,  -- info, warn, error, debug
    message TEXT NOT NULL,
    metadata TEXT,            -- JSON stored as TEXT
    created_at DATETIME NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (tool_id) REFERENCES tools(id) ON DELETE CASCADE
);
```

---

## ğŸ”§ æ ¸å¿ƒæ¥å£å®šä¹‰

### 1. DatabaseConnection - æ•°æ®åº“è¿æ¥æ¥å£

```rust
#[async_trait]
pub trait DatabaseConnection: Send + Sync {
    async fn get_pool(&self) -> Result<Pool<Sqlite>, DatabaseError>;
    async fn run_migration(&self) -> Result<(), DatabaseError>;
    async fn health_check(&self) -> Result<bool, DatabaseError>;
}
```

### 2. ToolRepository - å·¥å…·æ•°æ®è®¿é—®æ¥å£

```rust
#[async_trait]
pub trait ToolRepository: Send + Sync {
    async fn create_tool(&self, tool: &ToolSpec) -> Result<ToolId, RepositoryError>;
    async fn get_tool(&self, id: &ToolId) -> Result<ToolSpec, RepositoryError>;
    async fn update_tool(&self, id: &ToolId, tool: &ToolSpec) -> Result<(), RepositoryError>;
    async fn delete_tool(&self, id: &ToolId) -> Result<(), RepositoryError>;
    async fn list_tools(&self, filter: &ToolFilter) -> Result<Vec<ToolSpec>, RepositoryError>;
    async fn search_tools(&self, query: &str) -> Result<Vec<ToolSpec>, RepositoryError>;
    async fn count_tools(&self, filter: &ToolFilter) -> Result<usize, RepositoryError>;
}
```

### 3. ExecutionRepository - æ‰§è¡Œè®°å½•æ¥å£

```rust
#[async_trait]
pub trait ExecutionRepository: Send + Sync {
    async fn create_execution(&self, execution: &ExecutionRecord) -> Result<ExecutionId, RepositoryError>;
    async fn get_execution(&self, id: &ExecutionId) -> Result<ExecutionRecord, RepositoryError>;
    async fn update_execution(&self, id: &ExecutionId, status: &ExecutionStatus) -> Result<(), RepositoryError>;
    async fn list_executions(&self, filter: &ExecutionFilter) -> Result<Vec<ExecutionRecord>, RepositoryError>;
    async fn get_tool_executions(&self, tool_id: &ToolId) -> Result<Vec<ExecutionRecord>, RepositoryError>;
}
```

### 4. MetricsRepository - æŒ‡æ ‡æ•°æ®æ¥å£

```rust
#[async_trait]
pub trait MetricsRepository: Send + Sync {
    async fn record_execution(&self, tool_id: &ToolId, execution: &ExecutionResult) -> Result<(), RepositoryError>;
    async fn get_tool_metrics(&self, tool_id: &ToolId) -> Result<ToolMetrics, RepositoryError>;
    async fn update_metrics(&self, tool_id: &ToolId, metrics: &ToolMetrics) -> Result<(), RepositoryError>;
    async fn get_tenant_metrics(&self, tenant_id: &TenantId) -> Result<TenantMetrics, RepositoryError>;
}
```

---

## ğŸš¨ é”™è¯¯ç±»å‹å®šä¹‰

```rust
#[derive(Debug, thiserror::Error)]
pub enum DatabaseError {
    #[error("Connection failed: {0}")]
    ConnectionFailed(String),
    
    #[error("Migration failed: {0}")]
    MigrationFailed(String),
    
    #[error("Query failed: {0}")]
    QueryFailed(String),
    
    #[error("Transaction failed: {0}")]
    TransactionFailed(String),
}

#[derive(Debug, thiserror::Error)]
pub enum RepositoryError {
    #[error("Tool not found: {0}")]
    ToolNotFound(ToolId),
    
    #[error("Tool already exists: {0}")]
    ToolAlreadyExists(ToolId),
    
    #[error("Execution not found: {0}")]
    ExecutionNotFound(ExecutionId),
    
    #[error("Database error: {0}")]
    DatabaseError(String),
    
    #[error("Validation error: {0}")]
    ValidationError(String),
}
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### 1. æ•°æ®åº“æ¨¡å‹

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ToolRecord {
    pub id: ToolId,
    pub name: String,
    pub tool_type: String,
    pub version: String,
    pub tenant_id: TenantId,
    pub input_schema: String,  // JSON as TEXT
    pub output_schema: String, // JSON as TEXT
    pub config: String,        // JSON as TEXT
    pub tags: String,          // JSON array as TEXT
    pub category: Option<String>,
    pub registered_at: DateTime<Utc>,
    pub execution_config: String, // JSON as TEXT
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ExecutionRecord {
    pub id: ExecutionId,
    pub tool_id: ToolId,
    pub tenant_id: TenantId,
    pub input_data: String,    // JSON as TEXT
    pub output_data: Option<String>, // JSON as TEXT
    pub status: String,
    pub error_message: Option<String>,
    pub duration_ms: Option<i64>,
    pub started_at: DateTime<Utc>,
    pub completed_at: Option<DateTime<Utc>>,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ToolMetrics {
    pub tool_id: ToolId,
    pub tenant_id: TenantId,
    pub execution_count: i64,
    pub success_count: i64,
    pub error_count: i64,
    pub avg_duration_ms: Option<i64>,
    pub last_executed_at: Option<DateTime<Utc>>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}
```

### 2. æŸ¥è¯¢è¿‡æ»¤å™¨

```rust
#[derive(Debug, Clone)]
pub struct ToolFilter {
    pub tool_type: Option<ToolType>,
    pub tenant_id: Option<TenantId>,
    pub tags: Option<Vec<String>>,
    pub category: Option<String>,
    pub limit: Option<i64>,
    pub offset: Option<i64>,
}

#[derive(Debug, Clone)]
pub struct ExecutionFilter {
    pub tool_id: Option<ToolId>,
    pub tenant_id: Option<TenantId>,
    pub status: Option<ExecutionStatus>,
    pub start_date: Option<DateTime<Utc>>,
    pub end_date: Option<DateTime<Utc>>,
    pub limit: Option<i64>,
    pub offset: Option<i64>,
}
```

---

## ğŸ§ª æµ‹è¯•æ ‡å‡†

### 1. å•å…ƒæµ‹è¯•è¦æ±‚

- **æ•°æ®åº“è¿æ¥æµ‹è¯•**: è¿æ¥æ± åˆ›å»ºå’Œå¥åº·æ£€æŸ¥
- **è¿ç§»æµ‹è¯•**: æ•°æ®åº“è¿ç§»è„šæœ¬éªŒè¯
- **æ¨¡å‹æµ‹è¯•**: æ•°æ®æ¨¡å‹åºåˆ—åŒ–/ååºåˆ—åŒ–
- **æŸ¥è¯¢æµ‹è¯•**: SQL æŸ¥è¯¢è¯­å¥éªŒè¯

### 2. é›†æˆæµ‹è¯•è¦æ±‚

- **CRUD æ“ä½œæµ‹è¯•**: å®Œæ•´çš„å¢åˆ æ”¹æŸ¥æµç¨‹
- **äº‹åŠ¡æµ‹è¯•**: äº‹åŠ¡å›æ»šå’Œæäº¤
- **å¹¶å‘æµ‹è¯•**: å¤šçº¿ç¨‹å¹¶å‘è®¿é—®
- **æ€§èƒ½æµ‹è¯•**: æŸ¥è¯¢æ€§èƒ½åŸºå‡†

### 3. æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡**: > 85%
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡**: > 70%
- **é”™è¯¯è·¯å¾„æµ‹è¯•**: 100%
- **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**: 100%

---

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### 1. æ•°æ®åº“è¿æ¥

```rust
use stepflow_database::{DatabaseConnection, SqliteConnection};

let db = SqliteConnection::new("sqlite://data.db").await?;
db.run_migration().await?;
```

### 2. å·¥å…·æ“ä½œ

```rust
use stepflow_database::{ToolRepository, SqliteToolRepository};

let repo = SqliteToolRepository::new(pool);
let tool_id = repo.create_tool(&tool_spec).await?;
let tool = repo.get_tool(&tool_id).await?;
```

### 3. æ‰§è¡Œè®°å½•

```rust
use stepflow_database::{ExecutionRepository, SqliteExecutionRepository};

let exec_repo = SqliteExecutionRepository::new(pool);
let execution_id = exec_repo.create_execution(&execution_record).await?;
exec_repo.update_execution(&execution_id, &ExecutionStatus::Completed).await?;
```

---

## ğŸš€ è¿ç§»ç®¡ç†

### 1. è¿ç§»æ–‡ä»¶å‘½å

```
migrations/
â”œâ”€â”€ 001_create_tools_table.sql
â”œâ”€â”€ 002_create_executions_table.sql
â”œâ”€â”€ 003_create_metrics_table.sql
â””â”€â”€ 004_create_logs_table.sql
```

### 2. è¿ç§»è„šæœ¬ç¤ºä¾‹

```sql
-- 001_create_tools_table.sql
CREATE TABLE tools (
    id TEXT PRIMARY KEY CHECK (id REGEXP '^tool:[^/]+/[^@]+@[^@]+$'),
    name TEXT NOT NULL,
    tool_type TEXT NOT NULL,
    version TEXT NOT NULL,
    tenant_id TEXT NOT NULL,
    input_schema TEXT NOT NULL,
    output_schema TEXT NOT NULL,
    config TEXT NOT NULL,
    tags TEXT NOT NULL,
    category TEXT,
    registered_at DATETIME NOT NULL DEFAULT (datetime('now')),
    execution_config TEXT NOT NULL,
    created_at DATETIME NOT NULL DEFAULT (datetime('now')),
    updated_at DATETIME NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_tools_tenant_version ON tools(tenant_id, version);
CREATE INDEX idx_tools_category ON tools(category);
CREATE INDEX idx_tools_type ON tools(tool_type);
CREATE INDEX idx_tools_registered_at ON tools(registered_at);
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### 1. æŸ¥è¯¢æ€§èƒ½ç›®æ ‡

- **å·¥å…·æŸ¥è¯¢**: < 10ms (95th percentile)
- **æ‰§è¡Œè®°å½•æŸ¥è¯¢**: < 20ms (95th percentile)
- **æ‰¹é‡æ“ä½œ**: < 100ms (95th percentile)
- **å¤æ‚æŸ¥è¯¢**: < 50ms (95th percentile)

### 2. è¿æ¥æ± é…ç½®

```rust
pub struct ConnectionConfig {
    pub max_connections: u32,
    pub min_connections: u32,
    pub connect_timeout: Duration,
    pub idle_timeout: Duration,
    pub max_lifetime: Duration,
}
```

---

End of Document. 